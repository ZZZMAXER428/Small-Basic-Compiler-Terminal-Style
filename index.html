<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="google-site-verification" content="IZg6wywpr1xQH89vA1zJ7nnAHFwwiWux2LePPavXNyQ" />
    <title>AndroSB</title>
    <style>
        :root { --green: #33ff33; --dim: #0a3d0a; --bg: #050505; }
        body { background: #111; color: var(--green); font-family: 'Consolas', monospace; padding: 20px; margin: 0; }
        #editor { background: #000; border: 1px solid var(--dim); padding: 15px; margin-bottom: 10px; }
        textarea { background: transparent; border: none; color: var(--green); width: 100%; height: 180px; outline: none; font-size: 1rem; resize: none; }
        button { background: var(--dim); color: var(--green); border: 1px solid var(--green); padding: 10px 25px; cursor: pointer; font-weight: bold; }
        button:hover { background: var(--green); color: #000; }
        #console { background: var(--bg); border: 2px solid var(--dim); padding: 15px; height: 300px; overflow-y: auto; box-shadow: inset 0 0 10px #000; }
        #read-input { background: transparent; border: none; color: white; outline: none; font-family: inherit; font-size: inherit; width: 100px; border-bottom: 1px solid var(--green); display: none; }
        .system { color: #555; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div id="editor">
        <textarea id="code-input" spellcheck="false">
</textarea>
        <button id="run-btn">â–¶ RUN PROGRAM</button>
    </div>

    <div id="console">
        <div class="system">> androSB_terminal_ready!!</div></div>
        <div id="output-area"></div>
        <span id="prompt" style="display:none">> </span><input type="text" id="read-input">
    </div>

    <script>
        const outputArea = document.getElementById('output-area');
        const readInput = document.getElementById('read-input');
        const prompt = document.getElementById('prompt');
        let variables = {};
        let resolveInput;

        function print(text) {
            const div = document.createElement('div');
            div.textContent = text;
            outputArea.appendChild(div);
            document.getElementById('console').scrollTop = document.getElementById('console').scrollHeight;
        }

        function readNumber() {
            return new Promise(resolve => {
                readInput.style.display = 'inline';
                prompt.style.display = 'inline';
                readInput.focus();
                resolveInput = resolve;
            });
        }

        readInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const val = parseFloat(readInput.value);
                print("> " + readInput.value);
                readInput.value = '';
                readInput.style.display = 'none';
                prompt.style.display = 'none';
                resolveInput(isNaN(val) ? 0 : val);
            }
        });

        async function runProgram() {
            outputArea.innerHTML = '';
            variables = {};
            const lines = document.getElementById('code-input').value.split('\n');
            let i = 0;
            let skipBlock = false;

            while (i < lines.length) {
                let line = lines[i].trim();
                let lowerLine = line.toLowerCase();
                
                if (!line || line.startsWith("'")) { i++; continue; }

                // 1. INPUT
                if (line.includes("TextWindow.ReadNumber()")) {
                    const varName = line.split('=')[0].trim();
                    variables[varName] = await readNumber();
                }
                // 2. LOGIC (IF / ELSEIF / ELSE)
                else if (lowerLine.startsWith("if ") || lowerLine.startsWith("elseif ")) {
                    const condition = line.match(/(?:if|elseif) (.*) then/i)[1];
                    if (evaluateCondition(condition)) {
                        skipBlock = false; // Execute this block
                    } else {
                        i = jumpToNextBranch(lines, i);
                        continue;
                    }
                }
                else if (lowerLine === "else") {
                    // If we reached an Else, it means no previous If/ElseIf was true
                    skipBlock = false; 
                }
                else if (lowerLine === "endif") {
                    skipBlock = false;
                }
                // 3. OUTPUT
                else if (lowerLine.startsWith("textwindow.writeline")) {
                    const content = line.match(/\((.*)\)/)[1];
                    print(resolveValue(content));
                }
                // 4. MATH / VARS
                else if (line.includes("=") && !lowerLine.includes("if")) {
                    const [name, expr] = line.split("=").map(s => s.trim());
                    variables[name] = evaluateMath(expr);
                }
                i++;
            }
        }

        function resolveValue(token) {
            token = token.trim();
            if (token.startsWith('"')) return token.replace(/"/g, '');
            return variables[token] !== undefined ? variables[token] : token;
        }

        function evaluateMath(expr) {
            let processed = expr;
            for (let v in variables) {
                let re = new RegExp("\\b" + v + "\\b", "g");
                processed = processed.replace(re, variables[v]);
            }
            try { return eval(processed); } catch { return expr; }
        }

        function evaluateCondition(cond) {
            // Convert Small Basic syntax to JS
            let js = cond.replace(/<>/g, '!==')
                         .replace(/ And /gi, ' && ')
                         .replace(/ Or /gi, ' || ')
                         .replace(/([^<>!=])=([^=])/g, '$1 == $2'); // Fixes the e=10 issue
            
            for (let v in variables) {
                let re = new RegExp("\\b" + v + "\\b", "g");
                js = js.replace(re, variables[v]);
            }
            try { return eval(js); } catch { return false; }
        }

        function jumpToNextBranch(lines, index) {
            let depth = 0;
            for (let j = index + 1; j < lines.length; j++) {
                let l = lines[j].trim().toLowerCase();
                if (l.startsWith("if ")) depth++;
                if (l === "endif") {
                    if (depth === 0) return j;
                    depth--;
                }
                if (depth === 0 && (l.startsWith("elseif ") || l === "else")) return j - 1;
            }
            return lines.length;
        }

        document.getElementById('run-btn').addEventListener('click', runProgram);
    </script>
</body>
</html>
